<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <title>Ischool Foci</title>
  <script src="http://d3js.org/d3.v2.min.js?2.9.3"></script>
  <style>
    html, body, .content {
      //background-color: #D0CBAC;
      height:100%;
      margin:0;
      font-family: arial,"Helvetica Neue",helvetica,sans-serif;
    }
    .content{
      display:block;
      padding-left:301px;
    }
    #sidebar {
      background-color:#EEE;
      height:100%;
      padding:5px;
      width:230px; /* total - border */
      float:left;
      margin-left:-301px;
      border-right:solid #AAA 1px;
      overflow:auto;
      /*box-shadow:         inset 0 0 10px #000000;*/
    }
    #error{display:none; color:#FF0066;}

    input[type="text"] {
          border: 1px solid #ccc;
          padding: 6px 4px;
          outline: none;
          border-radius: 2px;
          font: 13px "HelveticaNeue", "Helvetica Neue", Helvetica, Arial, sans-serif;
          color: #777;
          margin: 0;
          width: 150px;
          max-width: 100%;
          /*display: block;*/
          margin-bottom: 5px;
          background: #fff; 
          }

    h1{color: #FF0066}
    #header{border-bottom: solid 1px #AAA;}
   
    #chart {
      width:100%;
      height:100%;
      display:block;
      float:right;
      overflow:hidden;
    }
    .link {
      stroke: #EEE;
      stroke-opacity: .9;
    }
    .node {
    }
    .student {
      opacity:0.6;
      font-size: 14px;
    }
    .category {
      opacity:0.7;
      font-size: 20px;
    }
    .face{
      display: inline-block;
      width: 64px;
      height: 64px;
    }â€‹
  </style>
</head>

<body>

  <div class="content">
    <div id="sidebar">
      <div id="header">

      <h1>The I-School Interest Graph</h1>
      </div>
      <h3>Filters</h3>
      <form id='filters'>
        <p>Find someone you know..</p>
        <input id='studName' type="text" name="name" value="" placeholder="Student name.."><br>
        <p>Or filter by degree..</p>
        <input id='mims13_checkbox' class='checkbox_filters' type="checkbox" name="MIMS13" value="MIMS 2013"> MIMS 2013<br>
        <input id='mims14_checkbox' class='checkbox_filters' type="checkbox" name="MIMS14" value="MIMS 2014"> MIMS 2014<br>
        <input id='phd_checkbox' class='checkbox_filters' type="checkbox" name="PHD" value="Ph.D. Student"> Ph.D. Student<br>
      </form>
      <h3>More Information</h3>
      <div id='filter_results'>  
        <ul id='studInfo'>
          <li>append focues or stud info here</li>
        </ul>
      </div>
      <p id='error'>No results found..</p>

    </div>
      <div id="test">
      </div>
    </div>
    <div id="chart">
    </div>
  </div>

<script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
<script type="text/javascript" src="getStudData.js" ></script>
<script type="text/javascript" src="js/filters.js" ></script>
<script type="text/javascript">

  $("document").ready(function() {
    //load webpage from php
    $.ajax({
      // Manually input your url here:
      url: 'http://people.ischool.berkeley.edu/~taeil2/ischoolppl/curl2.php #content-area',
      success: function(data) {
        // Pulls data from the ischool ppl website
        cleanText(data);
        // console.log all important objects available
        console.log('phraseCountArray:');
        console.log(phraseCountArray);
        console.log('focusCategory:');
        console.log(focusCategory);
        console.log('categoryFocus:');
        console.log(categoryFocus);
        console.log('students:')
        console.log(students);
        // create graph
        createGraphData();
        initializeNodes();
      }
    });
  });

  Array.prototype.pushUnique = function (item){
    if(this.indexOf(item) == -1) {
      this.push(item);
      return true;
    }
    return false;
  }

  function createGraphData() {

    // Array of categories {"Big Data": 0, "Design": 1, ...}
    for (var studentKey in students){
      var studentCategories = students[studentKey][kCategory];
      //console.log(students[studentKey], studentCategories);
      for(var categoryKey in studentCategories) {
        var category = studentCategories[categoryKey];
        if(category && category.substring && !(category in categories)) {
          categories[category] = Object.keys(categories).length;
        }
      }
    }

    // Add categories to nodes
    for (var categoryKey in categories) {
      masterNodes.push({"name": categoryKey, "group": 2, "size":phraseCountArray[categoryKey], "on":false});
    }

    categoryCount = masterNodes.length;
    studentCount = categoryCount;

    // Create nodes and links
    for (var studentKey in students){
      var student = students[studentKey];
      var studentCategories = students[studentKey][kCategory];
      // List of Arrays of student nodes [{"name": "Bob", "url": "", ...}]
      masterNodes.push({
        "name": student[kName],
        "group": 1,
        "url": student[kImage],
        "class": student[kClass],
        "id": student[kName].replace(/\s/g, "").replace(/\(|\)/g, "").toLowerCase(),
        "on":false
      });
      for(var categoryKey in studentCategories) {
        var category = studentCategories[categoryKey];
        if(category && category.substring) {
          // Array of links {"source":1,"target":0,"value":100}
          masterLinks.push({
              "source": studentCount,
              "target": categories[category],
              "value": 1
          });
        }
      }
      studentCount += 1;
    }
  }

  //Initialize variables and graph

  var masterNodes = [],
    masterLinks = [],
    nodes = [],
    links = [],
    categories = {},
    kName = 0,
    kImage = 1,
    kClass = 2,
    kCategoryRaw = 3,
    kCategory = 4;
    linkedByIndex = {};
    categoryCount = 0;
    studentCount = 0;

  var w = 1000,
    h = 1000,
    r = 5;

  var color = d3.scale.category20();

  var svg = d3.select("#chart").append("svg")
    .attr("viewBox", "0 0 " + w + " " + h )
    // .attr("width", w)
    // .attr("height", h);

  var force = d3.layout.force()
    .gravity(.05)
    .charge(-150)
    .linkDistance(30)
    .linkStrength(.1)
    .size([w, h]);

  force
    .distance(function(d) {
      return d.value
    })
    .nodes(nodes)
    .links(links);

  // node.attr("cx", function(d) { return d.x = Math.max(r, Math.min(w - r, d.x)); })
  //         .attr("cy", function(d) { return d.y = Math.max(r, Math.min(h - r, d.y)); });

  force.on("tick", function() {
      link.attr("x1", function(d) { return d.source.x; })
          .attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; })
          .attr("y2", function(d) { return d.target.y; });

      node.attr("transform", function(d) { return "translate(" + Math.min(Math.abs(d.x), w) + "," + Math.min(Math.abs(d.y), h) + ")"; });
  });

  var link = svg.selectAll(".link");
  var node = svg.selectAll(".node");

  function initializeNodes(){
    // var i=0;
    // for (var key in categories){
    //   nodes.push(masterNodes[i]);
    //   i++;
    // }
    masterNodes.forEach(function(d) {
      nodes.push(d);
    });
    console.log('nodes:')
    console.log(nodes);
    start();
  }

  // These are the functions for adding and removing nodes and links

  function expandNode(categoryName){
    // First, close the node to avoid repeats
    closeNode(categoryName);
    masterLinks.forEach(function(d){
      // masterLinks actually changes when you push an object to links. console.log masterLinks to see. The 2nd part of the if accomodates for this change.
      if (d.target == categories[categoryName] || d.target.index == categories[categoryName]){
        links.push(d);
        // If the source index matches the node index, show that node
        var nodeIndex = d.source;
        nodes.forEach(function(e){
          if (e.index == nodeIndex){
            e.on = true;
            showPerson(e);
          }
        });
      }
    });
    updateLinks();

    // add links and nodes to that node
  }

  function showPerson(person){
    svg.select("#"+person.id+"circ").attr("r", r);
    svg.select("#"+person.id+"text").text(person.name);
  }

  function hidePerson(person){
    svg.select("#"+person.id+"circ").attr("r", 0);
    svg.select("#"+person.id+"text").text("");
  }

  function closeNode(categoryName){
    var i = 0;
    var spliceCounter = [];
    links.forEach(function(d){
      if (d.target.name == categoryName){
        spliceCounter.push(i);
      }
      i++;
    });
    var removedItems = 0;
    spliceCounter.forEach(function(d){
      links.splice(d-removedItems,1);
      removedItems++;
    });
    updateLinks();
    // remove all links tied to the node
  }

  function expandPerson(){
    // remove all links tied to the node
    // add all links tied to the node
  }

  function closePerson(){
    // remove the node and links tied to the node
  }




          

  function start(){
    node = node.data(force.nodes(), function(d) { return d.id;});
    node.enter().append("g")
      .call(force.drag)
      .attr("class", "node");
    node.append("circle")
      .attr("cursor", "pointer")
      .attr("id", function(d) { return d.id+"circ"; })
      //.style("fill", "#A1B9E6")
      .style("fill", function(d) {
        if (d.class == "MIMS 2014") {
          return "#aec7e8";
        } else if (d.class == "MIMS 2013") {
          return "#c5b0d5";
        } else if (d.class == "Ph.D. Student") {
          return "#ffbb78";
        } else {
          return "#6baed6";
        }
      })
      .style("stroke", function(d) { return d3.rgb(color(d.group)).darker(); })
      .on("click", function(d) {
        if (d.group ==1){
          // enter functions for expanding or hiding person
          console.log(d);
        }
        // If clicking a group, expand that group
        else{
          if (d.on == false){
            expandNode(d.name);
            d.on = true;
          }
          else{
            closeNode(d.name);
            d.on = false;
          }
        }
      })
      .attr("r", function(d) {
        if(d.group == 1) {
          return 0;
        }
        else {
          return d.size*1.5;
        }
      });

    node.append("text")
      .attr("dx", -30)
      .attr("dy", 20)
      .attr("id", function(d) { return d.id+"text"; })
      .attr("class", function(d) {
        if(d.group == 1) {
          return "student";
        }
        else {
          return "category";
        }
      })
      .text(function(d) {
        if(d.group == 2) {
          return d.name;
        }
      });

    node.exit().remove();

    force.start();
  }

  function updateLinks() {
    link = link.data(force.links(), function(d) { return d.source.id + "-" + d.target.id; });
    link.enter().append("line").attr("class", "link");
    link.exit().remove();

    
    // This code needs to be redone, or the links will appear on top of the nodes...
    node = node.data(force.nodes(), function(d) { return d.id;});
    node.enter().append("g")
      .call(force.drag)
      .attr("class", "node");
    node.append("circle")
      .attr("cursor", "pointer")
      .attr("id", function(d) { return d.id+"circ"; })
      //.style("fill", "#A1B9E6")
      .style("fill", function(d) {
        if (d.class == "MIMS 2014") {
          return "#aec7e8";
        } else if (d.class == "MIMS 2013") {
          return "#c5b0d5";
        } else if (d.class == "Ph.D. Student") {
          return "#ffbb78";
        } else {
          return "#6baed6";
        }
      })
      .style("stroke", function(d) { return d3.rgb(color(d.group)).darker(); })
      .on("click", function(d) {
        if (d.group ==1){
          // enter functions for expanding or hiding person
          console.log(d);
        }
        // If clicking a group, expand that group
        else{
          if (d.on == false){
            expandNode(d.name);
            d.on = true;
          }
          else{
            closeNode(d.name);
            d.on = false;
          }
        }
      })
      .attr("r", function(d) {
        if(d.group == 1) {
          return 0;
        }
        else {
          return d.size*1.5;
        }
      });

    node.append("text")
      .attr("dx", -30)
      .attr("dy", 20)
      .attr("id", function(d) { return d.id+"text"; })
      .attr("class", function(d) {
        if(d.group == 1) {
          return "student";
        }
        else {
          return "category";
        }
      })
      .text(function(d) {
        if(d.group == 2) {
          return d.name;
        }
      });
    // up to here

    node.exit().remove();
    
    force.start(); //Note: This changes the format of links

    // Only nodes with connections are displayed

    // Get a list of people with links
    var linkedPeople = [];
    links.forEach(function(d){
      linkedPeople.push(d.source.index);
    });
    console.log(linkedPeople);

    // First hide everyone 
    nodes.forEach(function(d){
      if (d.group == 1){
        hidePerson(d);
        // Then reshow everyone with links
        for (var i=0;i<linkedPeople.length;i++){
          if (d.index == linkedPeople[i]){
            showPerson(d);
          }
        }
      }
    });

  }

  // This is an unused function. It's the old one that worked, so it's kept here for reference
  function studentGraph() {

    graph["nodes"] = nodes;
    graph["links"] = links;

    var w = 1400,
        h = 800,
        r = 5;

    var svg = d3.select("body").append("svg")
        .attr("width", w)
        .attr("height", h);

    var force = d3.layout.force()
        .gravity(.05)
        .charge(-150)
        .linkDistance(10)
        .linkStrength(0.1)
        .size([w, h]);

    force
      .distance(function(d) {
        return d.value
      })
      .nodes(graph.nodes)
      .links(graph.links)
      .start();

    var link = svg.selectAll(".link")
      .data(graph.links)
      .enter()
      .append("line")
      .attr("class", "link");

    var node = svg.selectAll(".node")
      .data(graph.nodes)
      .enter()
      .append("g")
      .call(force.drag);

    var color = d3.scale.category20();

    /* append circle to node */
    node.append("circle")
      .attr("cursor", "pointer")
      //.style("fill", "#A1B9E6")
      .style("fill", function(d) {
        if (d.class == "MIMS 2014") {
          return "#aec7e8";
        } else if (d.class == "MIMS 2013") {
          return "#c5b0d5";
        } else if (d.class == "Ph.D. Student") {
          return "#ffbb78";
        } else {
          return "#6baed6";
        }
      })
      .attr("id", function(d) { return d.id; })
      .style("stroke", function(d) { return d3.rgb(color(d.group)).darker(); })
      .on("mouseover", fade(.1))
      .on("mouseout", fade(1))
      .on("click", function(d) { alert("Hello world"); })
      .attr("r", function(d) {
        if(d.group == 1) {
          return r;
        } else {
          return d.size*1.5;
        }
      });

    /* append image to node *
    node.append("image")
        .attr("xlink:href", function(d) { return d.url; })
        .attr("x", -52)
        .attr("y", -52)
        .attr("width", 64)
        .attr("height", 64);
    */

    node.append("text")
      .attr("dx", -30)
      .attr("dy", 20)
        .attr("class", function(d) {
        if(d.group == 1) {
            return "student";
        } else {
            return "category";
        }
        })
      .text(function(d) { return d.name });

    force.on("tick", function() {
        link.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

        node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
    });

    var linkedByIndex = {};
    graph.links.forEach(function(d) {
        linkedByIndex[d.source.index + "," + d.target.index] = 1;
    });

    function isConnected(a, b) {
        return linkedByIndex[a.index + "," + b.index] || linkedByIndex[b.index + "," + a.index] || a.index == b.index;
    }

    function fade(opacity) {
        return function(d) {
            console.log(d)
            node.style("stroke-opacity", function(o) {
                thisOpacity = isConnected(d, o) ? 1 : opacity;
                this.setAttribute('fill-opacity', thisOpacity);
                return thisOpacity;
            });

            link.style("stroke-opacity", opacity).style("stroke-opacity", function(o) {
                return o.source === d || o.target === d ? 1 : opacity;
            });
        };
    }

    for (i in students) {
        $('.content').append('<img class="face" id='+ students[i][0].replace(/\s/g, "").toLowerCase() + ' src=' + students[i][1] + '></img>')
    }
    /*
    $('.face').mouseover(function(d){
            d3.select("#" + d.id).call(fade(.1));
    })

    $('.face').mouseout(function(){
        d3.select("#" + d.id).call(fade(1));
    })
    */
  };

</script>

</body>
